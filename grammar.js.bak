module.exports = grammar({
	name: 'rnoweb',

	externals: $ => [
		$.latex_word,
		$._rnw_sig_begin,
		$._rnw_sig_end,
		$._rnw_env_end,
	],

	rules: {
		source_file: $ => 
			repeat(
				choice(
					$.rnoweb_environment,
					$.latex
				)
			),

		rnoweb_environment: $ =>
			seq(
				$.rnoweb_sig,
				optional(field("rnoweb_content", $.rnoweb_content)),
				"@"
			),

		rnoweb_sig: $ =>
			seq(
				'<<',
				optional(
					"echo = T"
				),
				'>>=='
			),

		rnoweb_content: $ =>
			repeat1(/[^@]+/),

		latex: $ =>
			field("latex", 
				/[^<]+/,
			),
	},
});
